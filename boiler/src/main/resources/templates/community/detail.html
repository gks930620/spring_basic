<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìƒì„¸ - ì»¤ë®¤ë‹ˆí‹°</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <th:block th:replace="~{layout/header :: headerStyle}"></th:block>
    <th:block th:replace="~{layout/footer :: footerStyle}"></th:block>

    <style>
        .post-detail {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .post-detail-header {
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .post-category {
            display: inline-block;
            padding: 4px 12px;
            background-color: #e1bee7;
            color: #6200ea;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .post-detail-title {
            font-size: 24px;
            font-weight: 500;
            color: #212121;
            margin-bottom: 16px;
        }

        .post-detail-meta {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #757575;
            flex-wrap: wrap;
        }

        .post-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .post-meta-item .material-icons {
            font-size: 18px;
        }

        .post-detail-stats {
            display: flex;
            gap: 16px;
            padding: 16px 24px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .post-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #757575;
        }

        .post-stat .material-icons {
            font-size: 18px;
        }

        .post-detail-content {
            padding: 32px 24px;
            line-height: 1.8;
            color: #424242;
            font-size: 15px;
        }

        .post-detail-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 16px 0;
        }

        .post-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            border-top: 1px solid #e0e0e0;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-icon {
            padding: 12px 16px;
            background-color: #f5f5f5;
            color: #424242;
            border: 1px solid #e0e0e0;
        }

        .btn-icon:hover {
            background-color: #e0e0e0;
        }

        .btn-icon.active {
            background-color: #e1bee7;
            color: #6200ea;
            border-color: #6200ea;
        }

        .btn .material-icons {
            font-size: 18px;
        }

        .post-nav-actions {
            display: flex;
            justify-content: space-between;
            padding: 24px;
            background-color: #fafafa;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #424242;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn-primary {
            background-color: #6200ea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5000ca;
        }

        .btn-primary .material-icons {
            color: white;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        .comments-section {
            background: white;
            border-radius: 8px;
            margin-top: 24px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .comments-header {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #212121;
        }

        .comments-header .material-icons {
            color: #6200ea;
        }

        .comment-write {
            margin-bottom: 24px;
        }

        .comment-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            min-height: 80px;
            outline: none;
        }

        .comment-textarea:focus {
            border-color: #6200ea;
        }

        .comment-write-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .comment-list {
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .comment-item {
            padding: 16px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #424242;
        }

        .comment-author .material-icons {
            font-size: 20px;
            color: #757575;
        }

        .comment-date {
            font-size: 12px;
            color: #9e9e9e;
        }

        .comment-content {
            font-size: 14px;
            color: #616161;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 12px;
        }

        .comment-action-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            font-size: 12px;
            color: #757575;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .comment-action-btn:hover {
            color: #6200ea;
        }

        .comment-action-btn .material-icons {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{layout/header :: header}"></th:block>

    <main class="main-content">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" style="display: none; text-align: center; padding: 60px 20px; color: #757575;">
            <div style="font-size: 14px;">ë¡œë”© ì¤‘...</div>
        </div>

        <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
        <article class="post-detail" id="postDetail" style="display: none;">
            <div class="post-detail-header">
                <h1 class="post-detail-title" id="postTitle"></h1>
                <div class="post-detail-meta">
                    <span class="post-meta-item">
                        <span class="material-icons">person</span>
                        <span id="postAuthor"></span>
                    </span>
                    <span class="post-meta-item">
                        <span class="material-icons">schedule</span>
                        <span id="postDate"></span>
                    </span>
                </div>
            </div>

            <div class="post-detail-stats">
                <span class="post-stat">
                    <span class="material-icons">visibility</span>
                    <span id="postViewCount"></span>
                </span>
            </div>

            <div class="post-detail-content" id="postContent">
                <!-- ë‚´ìš©ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ (ì—ë””í„° ë‚´ ì´ë¯¸ì§€ í¬í•¨) -->
            </div>

            <!-- ì²¨ë¶€íŒŒì¼ (ë‹¤ìš´ë¡œë“œë§Œ) -->
            <div id="postAttachments" style="padding: 0 24px 24px 24px;"></div>

            <div class="post-nav-actions">
                <a href="/community" class="btn btn-secondary">
                    <span class="material-icons">list</span>
                    ëª©ë¡
                </a>
                <div id="postActions" style="display: none; gap: 8px;">
                    <button class="btn btn-primary" onclick="editPost()">
                        <span class="material-icons">edit</span>
                        ìˆ˜ì •
                    </button>
                    <button class="btn btn-danger" onclick="deletePost()">
                        <span class="material-icons">delete</span>
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </article>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="comments-section" id="commentsSection" style="display: none;">
            <div class="comments-header">
                <span class="material-icons">comment</span>
                <span>ëŒ“ê¸€ <span id="commentCount">0</span></span>
            </div>

            <!-- ëŒ“ê¸€ ì‘ì„± (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ) -->
            <div class="comment-write" id="commentWriteBox" style="display: none;">
                <textarea id="commentContent" class="comment-textarea" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <div class="comment-write-actions">
                    <button class="btn btn-primary" onclick="submitComment()">
                        <span class="material-icons">send</span>
                        ëŒ“ê¸€ ì‘ì„±
                    </button>
                </div>
            </div>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div class="comment-list" id="commentList">
                <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
            </div>

            <!-- ëŒ“ê¸€ í˜ì´ì§• -->
            <div class="pagination" id="commentPagination" style="display: none; margin-top: 20px;">
                <!-- í˜ì´ì§• ë²„íŠ¼ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
            </div>
        </section>
    </main>

    <th:block th:replace="~{layout/footer :: footer}"></th:block>
    <th:block th:replace="~{layout/header :: headerScript}"></th:block>

    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
        let currentCommunityId = null;
        let currentUser = null;
        let currentCommentPage = 0; // í˜„ì¬ ëŒ“ê¸€ í˜ì´ì§€
        const commentPageSize = 10; // í˜ì´ì§€ë‹¹ ëŒ“ê¸€ ìˆ˜

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', async () => {
            // URLì—ì„œ ê²Œì‹œê¸€ ID ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            currentCommunityId = urlParams.get('id');

            if (!currentCommunityId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                location.href = '/community';
                return;
            }

            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ ëŒ“ê¸€ ë¡œë“œ (ìˆœì„œ ì¤‘ìš”!)
            await checkLoginStatus();
            await loadCommunityDetail(); // ê²Œì‹œê¸€ ë¡œë“œ (currentUser ì„¤ì • í›„)
            loadComments(); // ëŒ“ê¸€ ë¡œë“œ (currentUser ì„¤ì • í›„)
            loadFiles(); // íŒŒì¼ ë¡œë“œ (ë³„ë„ API)
        });

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        async function checkLoginStatus() {
            try {
                const response = await authFetch('/api/my/info');
                if (response.ok) {
                    const result = await response.json();
                    currentUser = result.data; // ApiResponseì—ì„œ data ì¶”ì¶œ
                    console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ:', currentUser.nickname);
                    // ë¡œê·¸ì¸í–ˆìœ¼ë©´ ëŒ“ê¸€ ì‘ì„± í¼ í‘œì‹œ
                    document.getElementById('commentWriteBox').style.display = 'block';
                } else {
                    throw new Error('Not logged in');
                }
            } catch (err) {
                console.log('âŒ ë¹„ë¡œê·¸ì¸ ìƒíƒœ');
                currentUser = null;
            }
        }

        // ê²Œì‹œê¸€ ìƒì„¸ ë¡œë“œ
        async function loadCommunityDetail() {
            try {
                showLoading(true);

                const response = await fetch(`/api/community/${currentCommunityId}`);

                if (!response.ok) {
                    throw new Error('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const result = await response.json();
                console.log('âœ… ê²Œì‹œê¸€ ë°ì´í„°:', result);

                // ApiResponse í˜•ì‹: { success, message, data }
                if (!result.success) {
                    throw new Error(result.message || 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                renderCommunityDetail(result.data);
                showLoading(false);

            } catch (error) {
                console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error);
                showLoading(false);
                alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                location.href = '/community';
            }
        }

        // ê²Œì‹œê¸€ ë Œë”ë§
        function renderCommunityDetail(data) {
            // ì œëª©
            document.getElementById('postTitle').textContent = data.title;

            // ì‘ì„±ì
            document.getElementById('postAuthor').textContent = data.nickname || data.username;

            // ì‘ì„±ì¼
            document.getElementById('postDate').textContent = formatDate(data.createdAt);

            // ì¡°íšŒìˆ˜
            document.getElementById('postViewCount').textContent = data.viewCount || 0;

            // ë‚´ìš© (DOMPurifyë¡œ XSS ë°©ì–´ ì²˜ë¦¬ í›„ ë Œë”ë§)
            const cleanContent = DOMPurify.sanitize(data.content, {
                ALLOWED_TAGS: [
                    // í…ìŠ¤íŠ¸ ì„œì‹
                    'p', 'br', 'strong', 'em', 'u', 's', 'span', 'div',
                    // ì œëª©
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    // ëª©ë¡
                    'ul', 'ol', 'li',
                    // ì¸ìš©/ì½”ë“œ
                    'blockquote', 'pre', 'code',
                    // ë§í¬
                    'a',
                    // ì´ë¯¸ì§€ (ì—ë””í„°ì—ì„œ ì‚½ì…í•œ ì´ë¯¸ì§€)
                    'img'
                ],
                ALLOWED_ATTR: [
                    // ìŠ¤íƒ€ì¼ (Quill ì—ë””í„° ì„œì‹ìš©)
                    'style', 'class',
                    // ë§í¬
                    'href', 'target', 'rel',
                    // ì´ë¯¸ì§€
                    'src', 'alt', 'width', 'height'
                ],
                ALLOW_DATA_ATTR: false, // data-* ì†ì„± ì°¨ë‹¨
                ALLOW_UNKNOWN_PROTOCOLS: false, // javascript: ê°™ì€ í”„ë¡œí† ì½œ ì°¨ë‹¨
            });
            document.getElementById('postContent').innerHTML = cleanContent;

            // ë³¸ì¸ ê²Œì‹œê¸€ì´ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            if (currentUser && currentUser.username === data.username) {
                document.getElementById('postActions').style.display = 'flex';
            }

            // ê²Œì‹œê¸€ í‘œì‹œ
            document.getElementById('postDetail').style.display = 'block';
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('postDetail').style.display = show ? 'none' : 'block';
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
        function editPost() {
            location.href = `/community/edit?id=${currentCommunityId}`;
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deletePost() {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                // 1. ì²¨ë¶€íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë³„ë„ API)
                const filesResponse = await fetch(`/api/files/detail?refId=${currentCommunityId}&refType=COMMUNITY&usage=ATTACHMENT`);

                if (filesResponse.ok) {
                    const filesResult = await filesResponse.json();
                    const files = filesResult.data || [];

                    // 2. ì²¨ë¶€íŒŒì¼ë“¤ ë¨¼ì € ì‚­ì œ
                    if (files.length > 0) {
                        console.log(`ğŸ“ ì²¨ë¶€íŒŒì¼ ${files.length}ê°œ ì‚­ì œ ì¤‘...`);
                        for (const file of files) {
                            try {
                                await authFetch(`/api/files/${file.fileId}`, {
                                    method: 'DELETE',
                                    credentials: 'include'
                                });
                                console.log(`âœ… íŒŒì¼ ì‚­ì œ: ${file.originalFileName}`);
                            } catch (err) {
                                console.warn(`âš ï¸ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ${file.originalFileName}`, err);
                            }
                        }
                    }
                }

                // 3. ê²Œì‹œê¸€ ì‚­ì œ
                const deleteResponse = await authFetch(`/api/community/${currentCommunityId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (deleteResponse.ok) {
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.href = '/community';
                } else {
                    const error = await handleApiError(deleteResponse);
                    showApiError(error);
                }
            } catch (error) {
                console.error('âŒ ì‚­ì œ ì—ëŸ¬:', error);
                if (error.message) {
                    alert(error.message);
                } else {
                    alert('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ========== ëŒ“ê¸€ ê¸°ëŠ¥ ==========

        // íŒŒì¼ ë¡œë“œ (ë³„ë„ API í˜¸ì¶œ)
        async function loadFiles() {
            try {
                // ATTACHMENT íŒŒì¼ ìƒì„¸ ì •ë³´ ì¡°íšŒ (ì›ë³¸ íŒŒì¼ëª… í¬í•¨)
                const response = await fetch(`/api/files/detail?refId=${currentCommunityId}&refType=COMMUNITY&usage=ATTACHMENT`);

                if (!response.ok) {
                    console.log('ì²¨ë¶€íŒŒì¼ ì—†ìŒ ë˜ëŠ” ì¡°íšŒ ì‹¤íŒ¨');
                    return;
                }

                const result = await response.json();
                const files = result.data || [];
                console.log('âœ… ì²¨ë¶€íŒŒì¼ ë°ì´í„°:', files);

                if (files && files.length > 0) {
                    renderAttachments(files);
                }
            } catch (error) {
                console.error('âŒ íŒŒì¼ ë¡œë“œ ì—ëŸ¬:', error);
                // ì—ëŸ¬ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ (ì²¨ë¶€íŒŒì¼ì€ ì„ íƒì‚¬í•­)
            }
        }

        // ì²¨ë¶€íŒŒì¼ ë Œë”ë§
        function renderAttachments(files) {
            const attachmentsHtml = `
                <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px; background: #f5f5f5;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #424242;">ì²¨ë¶€íŒŒì¼</h4>
                    ${files.map(file => {
                        return `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span class="material-icons" style="font-size: 20px; color: #757575;">attach_file</span>
                                <a href="${file.downloadUrl}" style="color: #6200ea; text-decoration: none;">
                                    ${file.originalFileName}
                                </a>
                                <span style="color: #9e9e9e; font-size: 12px;">(${formatFileSize(file.fileSize)})</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('postAttachments').innerHTML = attachmentsHtml;
        }


        // ========== ëŒ“ê¸€ ê¸°ëŠ¥ =========="

        // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
        async function loadComments(page = 0) {
            try {
                const response = await fetch(`/api/comments/community/${currentCommunityId}?page=${page}&size=${commentPageSize}`);

                if (!response.ok) {
                    throw new Error('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const result = await response.json();
                const data = result.data; // ApiResponseì—ì„œ data ì¶”ì¶œ
                console.log('âœ… ëŒ“ê¸€ ë°ì´í„°:', data);

                // ëŒ“ê¸€ ê°œìˆ˜ í‘œì‹œ (ì „ì²´ ê°œìˆ˜)
                document.getElementById('commentCount').textContent = data.totalElements || 0;

                // ëŒ“ê¸€ ë Œë”ë§
                renderComments(data.content);

                // í˜ì´ì§• ë Œë”ë§
                renderCommentPagination(data);

                // í˜„ì¬ í˜ì´ì§€ ì €ì¥
                currentCommentPage = page;

                // ëŒ“ê¸€ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('commentsSection').style.display = 'block';

            } catch (error) {
                console.error('âŒ ëŒ“ê¸€ ë¡œë“œ ì—ëŸ¬:', error);
                // ì—ëŸ¬ ì‹œ ë¹ˆ ëŒ“ê¸€ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('commentCount').textContent = '0';
                document.getElementById('commentList').innerHTML = '';
                document.getElementById('commentPagination').style.display = 'none';
                document.getElementById('commentsSection').style.display = 'block';
            }
        }

        // ëŒ“ê¸€ ë Œë”ë§
        function renderComments(comments) {
            const commentList = document.getElementById('commentList');

            if (comments.length === 0) {
                commentList.innerHTML = '<p style="text-align: center; color: #9e9e9e; padding: 40px 0;">ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            commentList.innerHTML = comments.map(comment => {
                const isMyComment = currentUser && currentUser.username === comment.username;

                return `
                    <div class="comment-item" data-comment-id="${comment.id}">
                        <div class="comment-header">
                            <div class="comment-author">
                                <span class="material-icons">account_circle</span>
                                <span>${comment.nickname || comment.username}</span>
                            </div>
                            <span class="comment-date">${formatDate(comment.createdAt)}</span>
                        </div>
                        <div class="comment-content" id="commentContent-${comment.id}">${escapeHtml(comment.content)}</div>
                        ${isMyComment ? `
                            <div class="comment-actions">
                                <button class="comment-action-btn" onclick="editComment(${comment.id})">
                                    <span class="material-icons">edit</span>
                                    ìˆ˜ì •
                                </button>
                                <button class="comment-action-btn" onclick="deleteComment(${comment.id})">
                                    <span class="material-icons">delete</span>
                                    ì‚­ì œ
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // ëŒ“ê¸€ ì‘ì„±
        async function submitComment() {
            const content = document.getElementById('commentContent').value.trim();

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
                return;
            }

            try {
                const response = await authFetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        communityId: currentCommunityId,
                        content: content
                    })
                });

                if (!response.ok) {
                    const error = await handleApiError(response);
                    showApiError(error);
                    return;
                }

                // ëŒ“ê¸€ ì‘ì„± ì„±ê³µ
                document.getElementById('commentContent').value = '';

                // ì²« í˜ì´ì§€ë¡œ ì´ë™ (ìµœì‹  ëŒ“ê¸€ì„ ë³´ê¸° ìœ„í•´)
                await loadComments(0); // ì²« í˜ì´ì§€ ë¡œë“œ

            } catch (error) {
                console.error('âŒ ëŒ“ê¸€ ì‘ì„± ì—ëŸ¬:', error);
                if (error.message) {
                    alert(error.message);
                } else {
                    alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ëŒ“ê¸€ ìˆ˜ì •
        function editComment(commentId) {
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            const contentElement = commentElement.querySelector('.comment-content');
            const currentContent = contentElement.textContent;

            const newContent = prompt('ëŒ“ê¸€ ìˆ˜ì •', currentContent);

            if (newContent === null) {
                return; // ì·¨ì†Œ
            }

            if (!newContent.trim()) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            updateComment(commentId, newContent.trim());
        }

        // ëŒ“ê¸€ ìˆ˜ì • API í˜¸ì¶œ
        async function updateComment(commentId, content) {
            try {
                const response = await authFetch(`/api/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        content: content
                    })
                });

                if (!response.ok) {
                    const error = await handleApiError(response);
                    showApiError(error);
                    return;
                }

                await loadComments(currentCommentPage); // í˜„ì¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ

            } catch (error) {
                console.error('âŒ ëŒ“ê¸€ ìˆ˜ì • ì—ëŸ¬:', error);
                if (error.message) {
                    alert(error.message);
                } else {
                    alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        async function deleteComment(commentId) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await authFetch(`/api/comments/${commentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await handleApiError(response);
                    showApiError(error);
                    return;
                }

                await loadComments(currentCommentPage); // í˜„ì¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ

            } catch (error) {
                console.error('âŒ ëŒ“ê¸€ ì‚­ì œ ì—ëŸ¬:', error);
                if (error.message) {
                    alert(error.message);
                } else {
                    alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì–´)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ëŒ“ê¸€ í˜ì´ì§• ë Œë”ë§
        function renderCommentPagination(pageData) {
            const pagination = document.getElementById('commentPagination');

            if (pageData.totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            const currentPage = pageData.page;
            const totalPages = pageData.totalPages;

            let html = '<div style="display: flex; justify-content: center; gap: 8px; align-items: center;">';

            // ì´ì „ ë²„íŠ¼
            if (currentPage > 0) {
                html += `<button onclick="loadComments(${currentPage - 1})" class="btn btn-secondary" style="padding: 8px 16px;">ì´ì „</button>`;
            }

            // í˜ì´ì§€ ë²ˆí˜¸
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-primary" style="padding: 8px 16px;">${i + 1}</button>`;
                } else {
                    html += `<button onclick="loadComments(${i})" class="btn btn-secondary" style="padding: 8px 16px;">${i + 1}</button>`;
                }
            }

            // ë‹¤ìŒ ë²„íŠ¼
            if (currentPage < totalPages - 1) {
                html += `<button onclick="loadComments(${currentPage + 1})" class="btn btn-secondary" style="padding: 8px 16px;">ë‹¤ìŒ</button>`;
            }

            html += '</div>';
            pagination.innerHTML = html;
            pagination.style.display = 'block';
        }
    </script>
</body>
</html>

