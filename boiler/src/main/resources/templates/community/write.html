h<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ì‘ì„± - ì»¤ë®¤ë‹ˆí‹°</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <th:block th:replace="~{layout/header :: headerStyle}"></th:block>
    <th:block th:replace="~{layout/footer :: footerStyle}"></th:block>

    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 500;
            color: #212121;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-header .material-icons {
            font-size: 32px;
            color: #6200ea;
        }

        .write-form {
            background: white;
            border-radius: 8px;
            padding: 32px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #424242;
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: ' *';
            color: #d32f2f;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: #6200ea;
        }

        .form-textarea {
            min-height: 300px;
            resize: vertical;
        }

        .form-help {
            font-size: 12px;
            color: #757575;
            margin-top: 6px;
        }

        .file-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #6200ea;
            background-color: #f5f5f5;
        }

        .file-upload-area .material-icons {
            font-size: 48px;
            color: #9e9e9e;
            margin-bottom: 8px;
        }

        .file-upload-area p {
            font-size: 14px;
            color: #757575;
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uploaded-file-info .material-icons {
            color: #757575;
        }

        .remove-file-btn {
            background: none;
            border: none;
            color: #d32f2f;
            cursor: pointer;
            padding: 4px;
        }

        .remove-file-btn .material-icons {
            font-size: 20px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: #6200ea;
            color: white;
            box-shadow: 0 2px 4px rgba(98, 0, 234, 0.3);
        }

        .btn-primary:hover {
            background-color: #5000ca;
            box-shadow: 0 4px 8px rgba(98, 0, 234, 0.4);
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #424242;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn .material-icons {
            font-size: 18px;
        }

        /* Quill ì—ë””í„° ê³ ì • í¬ê¸° ë° ìŠ¤í¬ë¡¤ */
        #editor {
            height: 600px;
        }

        .ql-container {
            height: calc(100% - 42px); /* íˆ´ë°” ë†’ì´ ì œì™¸ */
            overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        }

        .ql-editor {
            min-height: 100%;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{layout/header :: header}"></th:block>

    <main class="main-content">
        <div class="page-header">
            <h1>
                <span class="material-icons">edit</span>
                ê²Œì‹œê¸€ ì‘ì„±
            </h1>
        </div>

        <form class="write-form" onsubmit="return handleSubmit(event)">
            <div class="form-group">
                <label class="form-label required" for="title">ì œëª©</label>
                <input type="text" class="form-input" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="200">
            </div>

            <div class="form-group">
                <label class="form-label required">ë‚´ìš©</label>
                <!-- Quill ì—ë””í„° ì»¨í…Œì´ë„ˆ -->
                <div id="editor" style="height: 400px; background: white;"></div>
                <div class="form-help">ìµœì†Œ 10ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”. (ì—ë””í„° íˆ´ë°”ì˜ ì´ë¯¸ì§€ ë²„íŠ¼ìœ¼ë¡œ ë³¸ë¬¸ì— ì´ë¯¸ì§€ ì‚½ì… ê°€ëŠ¥)</div>
            </div>

            <div class="form-group">
                <label class="form-label">ì²¨ë¶€íŒŒì¼ (ì„ íƒ)</label>
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <span class="material-icons">attach_file</span>
                    <p>í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì²¨ë¶€í•˜ì„¸ìš”</p>
                    <p style="font-size: 12px; margin-top: 8px;">ëª¨ë“  íŒŒì¼ í˜•ì‹ ê°€ëŠ¥ (ì´ë¯¸ì§€, PDF, ë¬¸ì„œ ë“±)</p>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple onchange="handleFileSelect(event)">
                <div class="uploaded-files" id="uploadedFiles"></div>
            </div>

            <div class="form-actions">
            <div class="form-actions">
                <a href="/community" class="btn btn-secondary">
                    <span class="material-icons">close</span>
                    ì·¨ì†Œ
                </a>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">check</span>
                    ë“±ë¡
                </button>
            </div>
        </form>
    </main>

    <th:block th:replace="~{layout/footer :: footer}"></th:block>
    <th:block th:replace="~{layout/header :: headerScript}"></th:block>

    <!-- Quill.js Script -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        let quill; // Quill ì—ë””í„° ì¸ìŠ¤í„´ìŠ¤
        let attachedFiles = []; // ì²¨ë¶€íŒŒì¼ ë°°ì—´

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸ ë° ì—ë””í„° ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginAndRedirect();
            initQuillEditor();
        });

        // ë¡œê·¸ì¸ í™•ì¸ (API í˜¸ì¶œë¡œ ì •í™•í•˜ê²Œ ì²´í¬)
        function checkLoginAndRedirect() {
            authFetch('/api/my/info')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Not logged in');
                })
                .then(result => {
                    const userInfo = result.data; // ApiResponseì—ì„œ data ì¶”ì¶œ
                    console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸: true, ì‚¬ìš©ì:', userInfo.nickname);
                })
                .catch(err => {
                    console.log('âŒ ë¹„ë¡œê·¸ì¸ ìƒíƒœ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                });
        }

        // Quill ì—ë””í„° ì´ˆê¸°í™”
        function initQuillEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
                modules: {
                    toolbar: {
                        container: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'color': [] }, { 'background': [] }],
                            ['link', 'image'], // ì´ë¯¸ì§€ ë²„íŠ¼ ì¶”ê°€
                            ['clean']
                        ],
                        handlers: {
                            image: imageHandler // ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ í•¸ë“¤ëŸ¬
                        }
                    }
                }
            });
        }

        // ì—ë””í„° ë‚´ ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
        function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;

                // ì´ë¯¸ì§€ íŒŒì¼ ê²€ì¦
                if (!file.type.startsWith('image/')) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }

                // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì œí•œ)
                if (file.size > 10 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤!\n\nìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬ íŒŒì¼ í¬ê¸°: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
                    return;
                }

                try {
                    // ì„ì‹œ IDë¡œ ì„œë²„ì— ì—…ë¡œë“œ (refIdëŠ” ê²Œì‹œê¸€ ì‘ì„± ì‹œ ì—…ë°ì´íŠ¸)
                    const formData = new FormData();
                    formData.append('files', file);
                    formData.append('refId', 0); // ì„ì‹œ ID
                    formData.append('refType', 'COMMUNITY');
                    formData.append('usage', 'IMAGES');

                    const response = await authFetch('/api/files/upload', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    if (!response.ok) {
                        if (response.status === 413) {
                            throw new Error('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤! ìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        }
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                    }

                    const result = await response.json();
                    // ApiResponse êµ¬ì¡°: { data: [...], message: "..." }
                    const uploadedUrls = result.data || result;
                    const imageUrl = Array.isArray(uploadedUrls) ? uploadedUrls[0] : uploadedUrls;

                    // ì—ë””í„°ì— ì´ë¯¸ì§€ URL ì‚½ì…
                    const range = quill.getSelection(true);
                    const index = range ? range.index : quill.getLength();
                    quill.insertEmbed(index, 'image', imageUrl);
                    quill.setSelection(index + 1);

                    console.log('âœ… ì—ë””í„° ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', imageUrl);

                } catch (error) {
                    console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert(error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            };
        }

        // ì²¨ë¶€íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);

            // ëª¨ë“  íŒŒì¼ íƒ€ì… í—ˆìš©
            attachedFiles = [...attachedFiles, ...files];
            displayUploadedFiles();

            // input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            event.target.value = '';
        }

        // ì²¨ë¶€íŒŒì¼ ëª©ë¡ í‘œì‹œ
        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';

            if (attachedFiles.length === 0) return;

            attachedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'uploaded-file';

                // íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜
                let icon = 'insert_drive_file';
                if (file.type.startsWith('image/')) icon = 'image';
                else if (file.type.includes('pdf')) icon = 'picture_as_pdf';
                else if (file.type.includes('word') || file.type.includes('document')) icon = 'description';
                else if (file.type.includes('excel') || file.type.includes('sheet')) icon = 'table_chart';

                fileDiv.innerHTML = `
                    <div class="uploaded-file-info">
                        <span class="material-icons">${icon}</span>
                        <span>${file.name} (${formatFileSize(file.size)})</span>
                    </div>
                    <button type="button" class="remove-file-btn" onclick="removeFile(${index})">
                        <span class="material-icons">close</span>
                    </button>
                `;
                container.appendChild(fileDiv);
            });
        }

        // ì²¨ë¶€íŒŒì¼ ì œê±°
        function removeFile(index) {
            attachedFiles.splice(index, 1);
            displayUploadedFiles();
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }


        async function handleSubmit(event) {
            event.preventDefault();

            const title = document.getElementById('title').value.trim();
            // Quill ì—ë””í„°ì—ì„œ HTML ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const content = quill.root.innerHTML.trim();
            // ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸° (ê³µë°± ì²´í¬ìš©)
            const textContent = quill.getText().trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }

            if (!textContent || textContent.length < 5) {
                alert('ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }

            try {
                console.log('ğŸ“ ê²Œì‹œê¸€ ì‘ì„± ì‹œì‘...');

                // 1. ê²Œì‹œê¸€ ë¨¼ì € ë“±ë¡
                const communityData = {
                    title: title,
                    content: content // HTML í¬í•¨ëœ ë‚´ìš©
                };

                console.log('ğŸ“¤ ê²Œì‹œê¸€ ë°ì´í„°:', communityData);

                // credentials: 'include'ë¡œ ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì „ë‹¬ (Authorization í—¤ë” ë¶ˆí•„ìš”)
                const response = await authFetch('/api/community', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // ì¿ í‚¤ ìë™ ì „ë‹¬
                    body: JSON.stringify(communityData)
                });

                console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status);

                if (!response.ok) {
                    const error = await handleApiError(response);
                    console.error('âŒ ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨:', error);
                    showApiError(error);
                    return false;
                }


                const result = await response.json();
                const communityId = result.data; // ApiResponseì—ì„œ data ì¶”ì¶œ
                console.log('âœ… ê²Œì‹œê¸€ ì‘ì„± ì„±ê³µ! ID:', communityId);

                // 2. ì²¨ë¶€íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
                if (attachedFiles.length > 0) {
                    console.log(`ğŸ“ ì²¨ë¶€íŒŒì¼ ${attachedFiles.length}ê°œ ì—…ë¡œë“œ ì¤‘...`);

                    const formData = new FormData();
                    attachedFiles.forEach(file => {
                        formData.append('files', file);
                    });
                    formData.append('refId', communityId);
                    formData.append('refType', 'COMMUNITY');
                    formData.append('usage', 'ATTACHMENT'); // ì²¨ë¶€íŒŒì¼ì€ ATTACHMENT

                    const fileResponse = await authFetch('/api/files/upload', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    if (!fileResponse.ok) {
                        console.warn('âš ï¸ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨ (ê²Œì‹œê¸€ì€ ë“±ë¡ë¨)');
                    } else {
                        console.log('âœ… ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ!');
                    }
                }

                alert('ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/community';

            } catch (error) {
                console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error);
                alert(error.message || 'ê²Œì‹œê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            return false;
        }
    </script>
</body>
</html>

