# ğŸ³ ë¡œì»¬ Docker í™˜ê²½ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ
> ë¡œì»¬ì—ì„œëŠ” ì˜ ë˜ëŠ”ë° Dockerì—ì„œ ì•ˆ ë  ë•Œ í™•ì¸í•  ì‚¬í•­ë“¤
------------------------------------------------------------------------------------
## ğŸ“ íŒŒì¼ ê²½ë¡œ ê²°í•© ë¬¸ì œ
### ë¬¸ì œ í˜„ìƒ
- ì—ë””í„°ì—ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ â†’ **201 ì„±ê³µ**, í•˜ì§€ë§Œ **ì´ë¯¸ì§€ í‘œì‹œ ì•ˆë¨**
- ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ â†’ **404 ì—ëŸ¬**
- `<img src="/uploads/xxx.png">` ì´ë¯¸ì§€ ê¹¨ì§
### ì›ì¸
ê²½ë¡œ ê²°í•© ì‹œ ë¬¸ìì—´ ë‹¨ìˆœ ê²°í•©(`+`) ì‚¬ìš© ë° 
application.ymlì—ëŠ” C:/workspace/simple_side/doll_gacha/uploads/
application-prod.ymlì—ëŠ”  /app/uploads
ì´ë ‡ê²Œ ë’¤ì— / ê°€ ìˆëƒ ì—†ëƒ ì°¨ì´ì˜€ë‹¤.
```java
// âŒ ë¬¸ìì—´ ë‹¨ìˆœ ê²°í•© - yml ì„¤ì •ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§
uploadDir + filename = "/app/uploads" + "test.png" = "/app/uploadstest.png"  âŒ
uploadDir + filename = "/app/uploads/" + "test.png" = "/app/uploads/test.png" âœ…

// âœ… Paths.resolve() - yml ì„¤ì •ì— ìƒê´€ì—†ì´ í•­ìƒ ì •ìƒ ì‘ë™
Paths.get("/app/uploads").resolve("test.png")  = "/app/uploads/test.png"  âœ…
Paths.get("/app/uploads/").resolve("test.png") = "/app/uploads/test.png"  âœ…
```
### ì™œ Paths.resolve()ì¸ê°€?
- **yml ì„¤ì •ì— `/` ë¶™ì´ë“  ì•ˆ ë¶™ì´ë“  ìƒê´€ì—†ìŒ** â†’ ì„¤ì • ì‹¤ìˆ˜ ë°©ì§€
- **ê·¼ë³¸ì ì¸ í•´ê²°ì±…** - ê²½ë¡œ ê´€ë ¨ ë²„ê·¸ ì›ì²œ ì°¨ë‹¨
#### 3. Docker ë³¼ë¥¨ ë§¤í•‘ í™•ì¸
```yaml
# docker-compose.yml
services:
  app:
    volumes:
      - ./uploads:/app/uploads  # í˜¸ìŠ¤íŠ¸ â†” ì»¨í…Œì´ë„ˆ ì—°ê²°
```
ì°¸ê³  : ymlì—ì„œ  ìœˆë„ìš°ë“  ë¦¬ëˆ…ìŠ¤ë“  /  ë¡œ ê²½ë¡œí•´ë„ ì•Œì•„ì„œ jvmì´ ì²˜ë¦¬í•¨ 


-----------------------------------------------------------------------------------------------------
## ğŸ¯ 1. í™˜ê²½ë³„ ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸
### ë¡œì»¬ â†’ Docker ë°°í¬ ì‹œ í™•ì¸ì‚¬í•­

| ì²´í¬ | í•­ëª© | ì ìš© ìœ„ì¹˜ |
|------|------|----------|
| âœ… | íŒŒì¼ ê²½ë¡œ ê²°í•© ì‹œ Paths.resolve() ì‚¬ìš© | `FileUtil.java`, `FileController.java` |
| âœ… | ë³¼ë¥¨ ë§¤í•‘ìœ¼ë¡œ íŒŒì¼ ì˜ì†ì„± í™•ë³´ | `docker-compose.yml` â†’ `./uploads:/app/uploads` |
| âœ… | í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ | `docker-compose.yml` â†’ `environment:` ì„¹ì…˜ |
| âœ… | DB ì—°ê²° ë¬¸ìì—´ (localhost â†’ ì»¨í…Œì´ë„ˆëª…) | `application-prod.yml` + `docker-compose.yml` |
| âœ… | ë¸Œë¼ìš°ì € ì¿ í‚¤ ì •ë¦¬ | í™˜ê²½ ì „í™˜ ì‹œ ìˆ˜ë™ ì‚­ì œ í•„ìš” |

---

### ê° í•­ëª© ìƒì„¸ ì„¤ëª…

#### 1ï¸âƒ£ ë³¼ë¥¨ ë§¤í•‘ (`docker-compose.yml`)
```yaml
app:
  volumes:
    - ./uploads:/app/uploads  # í˜¸ìŠ¤íŠ¸ â†” ì»¨í…Œì´ë„ˆ ì—°ê²°
```
- **ì—­í• **: ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘í•´ë„ ì—…ë¡œë“œ íŒŒì¼ ìœ ì§€
- **ë¡œì»¬ í´ë”** `./uploads` â†” **ì»¨í…Œì´ë„ˆ í´ë”** `/app/uploads` ë™ê¸°í™”

#### 2ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ (`docker-compose.yml`)
```yaml
app:
  environment:
    # DB ì„¤ì • - ì»¨í…Œì´ë„ˆëª… 'db' ì‚¬ìš©
    SPRING_DATASOURCE_URL: jdbc:mariadb://db:3306/doll_gacha
    SPRING_DATASOURCE_USERNAME: doll_gacha
    SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-ckdlsk13!}
    
    # OAuth2 ì„¤ì • - .env íŒŒì¼ì—ì„œ ì½ì–´ì˜´
    KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
    KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
    GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
    GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    
    # JWT ì„¤ì •
    JWT_SECRET_KEY: ${JWT_SECRET_KEY}
    
    # ì•± URL
    APP_BASE_URL: ${APP_BASE_URL:-http://localhost:8080}
```
- **ì—­í• **: `.env` íŒŒì¼ì˜ ê°’ì„ ì»¨í…Œì´ë„ˆì— ì „ë‹¬
- `${VAR:-default}` í˜•íƒœë¡œ ê¸°ë³¸ê°’ ì§€ì • ê°€ëŠ¥

#### 3ï¸âƒ£ DB ì—°ê²° ë¬¸ìì—´ ë³€ê²½
```yaml
# application.yml (ë¡œì»¬)
url: jdbc:mariadb://localhost:3406/doll_gacha

# application-prod.yml (Docker)
url: ${SPRING_DATASOURCE_URL:jdbc:mariadb://localhost:3406/doll_gacha}
# â†’ docker-composeì—ì„œ jdbc:mariadb://db:3306/doll_gacha ë¡œ ë®ì–´ì”€
```
- **í•µì‹¬**: Docker ë„¤íŠ¸ì›Œí¬ì—ì„œëŠ” `localhost` ëŒ€ì‹  **ì»¨í…Œì´ë„ˆëª…(db)** ì‚¬ìš©
- í¬íŠ¸ë„ ë‚´ë¶€ í†µì‹ ì´ë¯€ë¡œ `3306` ì‚¬ìš© (í˜¸ìŠ¤íŠ¸ ë§¤í•‘ í¬íŠ¸ `3407` ì•„ë‹˜)

#### 4ï¸âƒ£ ë¸Œë¼ìš°ì € ì¿ í‚¤ ì •ë¦¬
```
ë¡œì»¬ â†’ Docker ì „í™˜ ì‹œ:
1. F12 (ê°œë°œìë„êµ¬) â†’ Application íƒ­
2. Cookies â†’ localhost
3. access_token, refresh_token ì‚­ì œ
4. ìƒˆë¡œê³ ì¹¨
```
- **ì´ìœ **: ë¡œì»¬ì—ì„œ ë°œê¸‰ë°›ì€ JWTê°€ Docker í™˜ê²½ì—ì„œ ìœ íš¨í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

---

### í™˜ê²½ë³„ ì„¤ì • ë¹„êµ

| ì„¤ì • | ë¡œì»¬ (`application.yml`) | Docker (`application-prod.yml` + `docker-compose.yml`) |
|------|--------------------------|--------------------------------------------------------|
| DB URL | `localhost:3406` | `db:3306` (ì»¨í…Œì´ë„ˆëª…) |
| íŒŒì¼ ê²½ë¡œ | `C:/workspace/.../uploads` | `/app/uploads` |
| í”„ë¡œíŒŒì¼ | `default` | `prod` (Dockerfileì—ì„œ ì§€ì •) |
| í¬íŠ¸ | `8080` | `8080:8080` (í˜¸ìŠ¤íŠ¸:ì»¨í…Œì´ë„ˆ) |
| OAuth redirect | `localhost:8080` | `${APP_BASE_URL}` (í™˜ê²½ë³€ìˆ˜) |

---

## ğŸ“ 2. ë””ë²„ê¹… ëª…ë ¹ì–´ ëª¨ìŒ

### Docker ë¡œê·¸ í™•ì¸

```powershell
# ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
docker-compose logs -f app

# ìµœê·¼ 100ì¤„ë§Œ í™•ì¸
docker-compose logs --tail=100 app
```

### ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í™•ì¸

```powershell
# ì—…ë¡œë“œ í´ë” íŒŒì¼ ëª©ë¡
docker exec -it doll_gacha_app ls -la /app/uploads/

# í™˜ê²½ë³€ìˆ˜ í™•ì¸
docker exec -it doll_gacha_app env | grep -E "(SPRING|FILE)"

# ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
docker exec -it doll_gacha_app /bin/sh
```

## ğŸ”‘ 4. í•µì‹¬ êµí›ˆ
### âŒ í”í•œ ì°©ê°ë“¤
1. **"ë¡œì»¬ì—ì„œ ë˜ë©´ Dockerì—ì„œë„ ëœë‹¤"**
   - ê²½ë¡œ, DB, í™˜ê²½ë³€ìˆ˜ ëª¨ë‘ ë‹¤ë¦„
2. **"ìƒëŒ€ ê²½ë¡œê°€ í¸í•˜ë‹¤"**
   - Dockerì—ì„œëŠ” ì ˆëŒ€ ê²½ë¡œê°€ ì•ˆì „
### âœ… ê¶Œì¥ ì‚¬í•­
1. **ê²½ë¡œ ì²˜ë¦¬ëŠ” í•­ìƒ `Paths.get().toAbsolutePath().normalize()` ì‚¬ìš©**
2. **ì¶©ë¶„í•œ ë¡œê·¸ ë‚¨ê¸°ê¸°** (Docker ë””ë²„ê¹…ì€ ë¡œê·¸ê°€ ìƒëª…)
---
## ğŸ“š ê´€ë ¨ íŒŒì¼ ëª©ë¡
- `src/main/resources/application-prod.yml` - Docker í™˜ê²½ ì„¤ì •
- `docker-compose.yml` - Docker êµ¬ì„±
- `Dockerfile` - ì´ë¯¸ì§€ ë¹Œë“œ ì„¤ì •

