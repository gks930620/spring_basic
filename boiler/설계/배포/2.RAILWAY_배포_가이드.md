# 🚀 Railway 배포 가이드

## 📋 개요
```
GitHub Push → Railway가 직접 감지 → Railway가 Dockerfile로 이미지 빌드 → 자동 배포
Docker Hub를 거치지 않음. Railway가 GitHub 저장소를 직접 감지해서 빌드 + 배포하는 것
```
---

## 📌 1단계: Railway 가입 및 프로젝트 생성

### 1-1. Railway 가입
1. https://railway.app 접속
2. **GitHub로 로그인** (권장)

### 1-2. 새 프로젝트 생성
1. **New Project** 클릭
2. 빈 프로젝트 생성

---

## 📌 2단계: MySQL 서비스 생성
> ⚠️ **중요**: 앱 서비스보다 MySQL 서비스를 먼저 만들어야 함!

 **이유 1 (환경변수)**: doll-gacha 서비스에서 `${{MySQL.MYSQLHOST}}`
    같은 변수로 MySQL을 참조하는데, MySQL 서비스가 먼저 존재해야 이 환경변수들이 생성됨.

 **이유 2 (Docker 특성)**: Docker 이미지는 "코드(애플리케이션)"만 포함하며, 
    데이터 저장공간은 포함하지 않음. 
   컨테이너가 재시작되면 내부 데이터는 사라지므로, 영속적인 DB는 반드시 별도 서비스로 분리해야 함.

1. 프로젝트에서 **+ New** → **Database** → **MySQL** 선택
2. 자동으로 DB 생성됨 (Online 상태가 될 때까지 대기)
3. MySQL 서비스 클릭 → **Variables** 탭에서 자동 생성된 환경변수 확인:

| 변수명 | 설명 |
|--------|------|
| `MYSQLHOST` | MySQL 호스트 주소 |
| `MYSQLPORT` | MySQL 포트 번호 |
| `MYSQLDATABASE` | 데이터베이스 이름 |
| `MYSQLUSER` | 사용자명 |
| `MYSQLPASSWORD` | 비밀번호 |

> 💡 **MySQL 서비스의 환경변수는 건들 필요 없음**. Railway가 자동으로 생성/관리함.

---

## 📌 3단계: doll-gacha 서비스 생성 (GitHub 연동)

1. 프로젝트에서 **+ New** → **GitHub Repo** 선택
2. GitHub 저장소 (`gks930620/doll_gacha`) 연결
3. Railway가 자동으로 Dockerfile을 감지하여 빌드 시작

### 3-1. Deploy on Push 확인
- 서비스 클릭 → **Settings** 탭
- **Source** 섹션에서 GitHub 저장소가 연결되어 있는지 확인
- **Automatic Deploys** 또는 **Deploy on Push**가 **Enabled** 상태인지 확인

---

## 📌 4단계: doll-gacha 서비스 환경변수 설정 ⭐ 핵심!

> ⚠️ **Railway 환경변수 참조 문법**: `${{서비스명.변수명}}`

**doll-gacha 서비스** 클릭 → **Variables** 탭에서 다음 환경변수 추가:

### 필수 환경변수

| 변수명 | 값 |
|--------|-----|
| `SPRING_PROFILES_ACTIVE` | `prod` |
| `SPRING_DATASOURCE_URL` | `jdbc:mariadb://${{MySQL.MYSQLHOST}}:${{MySQL.MYSQLPORT}}/${{MySQL.MYSQLDATABASE}}?allowPublicKeyRetrieval=true&useSSL=false` |
| `SPRING_DATASOURCE_USERNAME` | `${{MySQL.MYSQLUSER}}` |
| `SPRING_DATASOURCE_PASSWORD` | `${{MySQL.MYSQLPASSWORD}}` |

### OAuth2 환경변수 (카카오/구글 로그인용)

| 변수명 | 값 |
|--------|-----|
| `JWT_SECRET_KEY` | `your-jwt-secret-key-here` (최소 32자 이상) |
| `KAKAO_CLIENT_ID` | 카카오 REST API 키 |
| `KAKAO_CLIENT_SECRET` | 카카오 Client Secret |
| `GOOGLE_CLIENT_ID` | 구글 클라이언트 ID |
| `GOOGLE_CLIENT_SECRET` | 구글 클라이언트 보안 비밀번호 |
| `APP_BASE_URL` | `https://xxx.up.railway.app` (6단계에서 생성된 도메인) |

### ⚠️ 주의사항
```bash
# ❌ 잘못된 예시 (변수가 치환되지 않음)
SPRING_DATASOURCE_URL=jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DATABASE}

# ✅ 올바른 예시 (Railway 문법 + MariaDB 드라이버)
SPRING_DATASOURCE_URL=jdbc:mariadb://${{MySQL.MYSQLHOST}}:${{MySQL.MYSQLPORT}}/${{MySQL.MYSQLDATABASE}}?allowPublicKeyRetrieval=true&useSSL=false
```
> 💡 **MariaDB 드라이버 사용 시**: `jdbc:mysql://` 대신 `jdbc:mariadb://` 사용!
---

## 📌 5단계: Railway 도메인 생성
1. **doll-gacha 서비스** 클릭
2. **Settings** 탭 → **Networking** 섹션
3. **Generate Domain** 클릭
4. `xxx.up.railway.app` 형식의 도메인 생성됨
> 💡 **HTTPS는 Railway가 자동으로 처리함**. 별도 설정 불필요!
---
## 📌 6단계: OAuth2 개발자센터 설정 ⭐ 필수!
> ⚠️ **중요**: 배포 후 반드시 카카오/구글 개발자센터에서 Redirect URI를 추가해야 OAuth2 로그인이 작동함!
### 6-1. 카카오 개발자센터 설정
1. https://developers.kakao.com 접속 → 로그인
2. **내 애플리케이션** → 해당 앱 선택
3. **카카오 로그인** → **Redirect URI** 설정
4. 다음 URI 추가:
   ```
   https://xxx.up.railway.app/login/oauth2/code/kakao
   ```
   (xxx는 Railway에서 생성된 도메인으로 교체)

### 6-2. 구글 클라우드 콘솔 설정

1. https://console.cloud.google.com 접속 → 로그인
2. **API 및 서비스** → **사용자 인증 정보**
3. 해당 OAuth 2.0 클라이언트 ID 클릭
4. **승인된 리디렉션 URI**에 다음 추가:
   ```
   https://xxx.up.railway.app/login/oauth2/code/google
   ```
   (xxx는 Railway에서 생성된 도메인으로 교체)

---

## 📌 7단계: 배포 테스트
### 7-1. 자동 배포 테스트
```bash
git add .
git commit -m "테스트 커밋"
git push
```

### 7-2. 배포 확인
1. Railway 대시보드 → **Deployments** 탭
2. 빌드 로그 확인
3. ✅ 초록색 = 성공
4. ❌ 빨간색 = 실패 (로그 확인)

---


---
## 📝 체크리스트
- [ ] Railway 프로젝트 생성
- [ ] Railway MySQL 서비스 추가
- [ ] Railway에서 GitHub Repo로 서비스 생성
- [ ] Deploy on Push 활성화 확인
- [ ] Railway 서비스 환경변수 설정
- [ ] Railway 도메인 생성
- [ ] 4단계 환경변수에 APP_BASE_URL 추가
- [ ] 카카오 개발자센터 Redirect URI 추가
- [ ] 구글 클라우드 콘솔 Redirect URI 추가
- [ ] GitHub 커밋 & 푸시로 자동 배포 테스트
