<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>방 상세</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    /* 기본 채팅 스타일 */
    #chatList {
      list-style: none;
      padding: 0;
    }
    #chatList li {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 60%;
      word-wrap: break-word;
    }
    /* 시스템 메시지 (입장/퇴장) */
    .system-msg {
      color: gray;
      font-style: italic;
      text-align: center;
      background: none;
    }
    /* 내가 보낸 메시지 */
    .my-msg {
      background-color: #d0ebff;
      text-align: right;
      margin-left: auto;
    }
    /* 남이 보낸 메시지 */
    .other-msg {
      background-color: #f1f3f5;
      text-align: left;
      margin-right: auto;
    }
  </style>
</head>
<body>
<h2>채팅방</h2>
<div>
  <input type="text" id="msgInput" placeholder="메시지를 입력하세요">
  <button id="sendBtn">보내기</button>
</div>
<ul id="chatList"></ul>

<script>
  $(document).ready(function() {
      const token = localStorage.getItem("accessToken");
      if (!token) {
          alert("로그인한 사람만 방 목록 가능합니다");
          window.location.href = "/loginPage";
          return;
      }

      // ✅ 현재 로그인 사용자 이름 가져오기 (백엔드의 /me 엔드포인트 활용)
      let currentUser = null;
      $.ajax({
          url: `/me`,
          method: "GET",
          headers: { "Authorization": "Bearer " + token },
          async: false, // 연결 전에 꼭 값 가져오기
          success: function(user) {
              currentUser = user.username || user.name || user.id;
          },
          error: function() {
              alert("사용자 정보를 불러오지 못했습니다.");
          }
      });

      const roomId = window.location.pathname.split("/").pop();

      const socket = new SockJS('/ws-chat');
      const stompClient = Stomp.over(socket);

      stompClient.connect(
        { Authorization: "Bearer " + token , "roomId" : roomId },
        function(frame) {
            console.log('Connected: ' + frame);

            stompClient.subscribe(`/sub/room/${roomId}`, function(message) {
                let msg;
                try {
                    msg = JSON.parse(message.body);
                } catch (e) {
                    msg = { content: message.body };
                }

                // ✅ 1. 시스템 메시지 (입장/퇴장)
                if (!msg.sender) {
                    $('#chatList').append(
                        `<li class="system-msg">${msg.content}</li>`
                    );
                    return;
                }

                // ✅ 2. 내가 보낸 메시지 / 남이 보낸 메시지 구분
                if (msg.sender === currentUser) {
                    $('#chatList').append(
                        `<li class="my-msg"><b>${msg.sender}</b>: ${msg.content}</li>`
                    );
                } else {
                    $('#chatList').append(
                        `<li class="other-msg"><b>${msg.sender}</b>: ${msg.content}</li>`
                    );
                }
            });
        },
        function(error) {
            console.error('STOMP 연결 오류', error);
            alert("채팅 연결 실패");
        }
      );

      $('#sendBtn').click(function() {
          const msg = $('#msgInput').val();
          if (msg.trim() === "") return;

          stompClient.send(
              `/pub/room/${roomId}`,
              {},
              JSON.stringify({ content: msg })
          );

          $('#msgInput').val('');
      });
  });
</script>
</body>
</html>
